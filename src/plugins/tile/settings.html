<div class="form-group">
    <label for="gridSize" class="form-label">Grid Size:</label>
    <select id="gridSize" name="gridSize" class="form-input" onchange="updateGridPreview()">
        <option value="2x2">2×2</option>
        <option value="3x3">3×3</option>
        <option value="4x4">4×4</option>
        <option value="5x5">5×5</option>
        <option value="6x6">6×6</option>
        <option value="7x7">7×7</option>
        <option value="8x8">8×8</option>
        <option value="9x9">9×9</option>
        <option value="10x10">10×10</option>
    </select>
</div>

<div class="form-group">
    <input type="checkbox" id="showBorders" name="showBorders" checked onclick="this.value=this.checked ? 'true' : 'false';">
    <label for="showBorders">Show Grid Borders</label>
</div>

<div class="form-group">
    <label for="borderColor" class="form-label">Border Color:</label>
    <input type="color" id="borderColor" name="borderColor" value="#cccccc" class="form-input">
</div>

<div class="form-group">
    <label for="backgroundColor" class="form-label">Background Color:</label>
    <input type="color" id="backgroundColor" name="backgroundColor" value="#ffffff" class="form-input">
</div>

<div class="form-group">
    <label class="form-label">Tile Configuration:</label>
    <div id="tileConfigContainer">
        <div id="gridPreview" class="grid-preview"></div>
        <div class="tile-controls">
            <button type="button" id="addTileBtn" class="action-button">Add Tile</button>
            <button type="button" id="clearTilesBtn" class="action-button">Clear All Tiles</button>
        </div>
        <div id="tilesList" class="tiles-list"></div>
    </div>
</div>

<!-- Hidden input to store the tiles configuration JSON -->
<input type="hidden" id="tilesConfig" name="tilesConfig" value="[]">

<style>
.grid-preview {
    display: grid;
    gap: 1px;
    background-color: #ccc;
    border: 2px solid #999;
    margin: 10px 0;
    max-width: 300px;
    max-height: 300px;
    aspect-ratio: 1;
}

.grid-cell {
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    position: relative;
    min-height: 20px;
}

.grid-cell:hover {
    background-color: #e0e0e0;
}

.grid-cell.occupied {
    background-color: #4CAF50;
    color: white;
}

.grid-cell.selected {
    background-color: #2196F3;
    color: white;
}

.tile-controls {
    margin: 10px 0;
}

.tile-controls button {
    margin-right: 10px;
}

.tiles-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
}

.tile-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border: 1px solid #eee;
    margin-bottom: 5px;
    background-color: #f9f9f9;
}

.tile-item-info {
    flex: 1;
}

.tile-item-actions {
    display: flex;
    gap: 5px;
}

.tile-item-actions button {
    padding: 2px 8px;
    font-size: 12px;
}

.form-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin: 5px 0;
}

.form-row label {
    min-width: 80px;
}

.form-row input, .form-row select {
    flex: 1;
    max-width: 100px;
}
</style>

<script>
let currentGrid = { cols: 4, rows: 4 };
let tiles = [];
let selectedCells = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set defaults
    document.getElementById('gridSize').value = '4x4';
    document.getElementById('showBorders').checked = true;
    document.getElementById('showBorders').value = 'true';
    
    // Initialize grid
    updateGridPreview();
    
    // Event listeners
    document.getElementById('addTileBtn').addEventListener('click', showAddTileDialog);
    document.getElementById('clearTilesBtn').addEventListener('click', clearAllTiles);
});

function updateGridPreview() {
    const gridSize = document.getElementById('gridSize').value;
    const [cols, rows] = gridSize.split('x').map(Number);
    currentGrid = { cols, rows };
    
    const preview = document.getElementById('gridPreview');
    preview.innerHTML = '';
    preview.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    preview.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    
    for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.col = col;
            cell.dataset.row = row;
            cell.addEventListener('click', () => toggleCellSelection(col, row));
            preview.appendChild(cell);
        }
    }
    
    updateGridDisplay();
}

function toggleCellSelection(col, row) {
    const cellIndex = selectedCells.findIndex(cell => cell.col === col && cell.row === row);
    
    if (cellIndex >= 0) {
        selectedCells.splice(cellIndex, 1);
    } else {
        selectedCells.push({ col, row });
    }
    
    updateGridDisplay();
}

function updateGridDisplay() {
    const cells = document.querySelectorAll('.grid-cell');
    
    cells.forEach(cell => {
        const col = parseInt(cell.dataset.col);
        const row = parseInt(cell.dataset.row);
        
        cell.className = 'grid-cell';
        cell.textContent = '';
        
        // Check if occupied by a tile
        const occupyingTile = tiles.find(tile => 
            col >= tile.x && col < tile.x + tile.width &&
            row >= tile.y && row < tile.y + tile.height
        );
        
        if (occupyingTile) {
            cell.classList.add('occupied');
            cell.textContent = occupyingTile.plugin_id;
        }
        
        // Check if selected
        const isSelected = selectedCells.some(selected => selected.col === col && selected.row === row);
        if (isSelected) {
            cell.classList.add('selected');
        }
    });
}

function showAddTileDialog() {
    if (selectedCells.length === 0) {
        alert('Please select cells in the grid first');
        return;
    }
    
    // Calculate tile bounds
    const minCol = Math.min(...selectedCells.map(c => c.col));
    const maxCol = Math.max(...selectedCells.map(c => c.col));
    const minRow = Math.min(...selectedCells.map(c => c.row));
    const maxRow = Math.max(...selectedCells.map(c => c.row));
    
    const width = maxCol - minCol + 1;
    const height = maxRow - minRow + 1;
    
    // Check if selection forms a rectangle
    if (selectedCells.length !== width * height) {
        alert('Please select a rectangular area');
        return;
    }
    
    // Check for overlaps with existing tiles
    const hasOverlap = tiles.some(tile => 
        !(minCol >= tile.x + tile.width || 
          maxCol < tile.x || 
          minRow >= tile.y + tile.height || 
          maxRow < tile.y)
    );
    
    if (hasOverlap) {
        alert('Selected area overlaps with existing tiles');
        return;
    }
    
    const pluginId = prompt('Enter plugin ID (e.g., clock, weather, calendar):');
    if (!pluginId) return;
    
    // Create tile
    const tile = {
        x: minCol,
        y: minRow,
        width: width,
        height: height,
        plugin_id: pluginId,
        plugin_settings: {}
    };
    
    tiles.push(tile);
    selectedCells = [];
    updateGridDisplay();
    updateTilesList();
    updateTilesConfig();
}

function removeTile(index) {
    tiles.splice(index, 1);
    updateGridDisplay();
    updateTilesList();
    updateTilesConfig();
}

function clearAllTiles() {
    tiles = [];
    selectedCells = [];
    updateGridDisplay();
    updateTilesList();
    updateTilesConfig();
}

function updateTilesList() {
    const list = document.getElementById('tilesList');
    list.innerHTML = '';
    
    tiles.forEach((tile, index) => {
        const item = document.createElement('div');
        item.className = 'tile-item';
        
        item.innerHTML = `
            <div class="tile-item-info">
                <strong>${tile.plugin_id}</strong><br>
                Position: (${tile.x}, ${tile.y}), Size: ${tile.width}×${tile.height}
            </div>
            <div class="tile-item-actions">
                <button type="button" onclick="editTile(${index})">Edit</button>
                <button type="button" onclick="removeTile(${index})">Remove</button>
            </div>
        `;
        
        list.appendChild(item);
    });
}

function editTile(index) {
    const tile = tiles[index];
    const newPluginId = prompt('Enter plugin ID:', tile.plugin_id);
    
    if (newPluginId !== null && newPluginId !== tile.plugin_id) {
        tile.plugin_id = newPluginId;
        updateGridDisplay();
        updateTilesList();
        updateTilesConfig();
    }
}

function updateTilesConfig() {
    document.getElementById('tilesConfig').value = JSON.stringify(tiles);
}

// Load existing configuration if available
function loadTilesConfig(configJson) {
    try {
        tiles = JSON.parse(configJson || '[]');
        updateGridDisplay();
        updateTilesList();
    } catch (e) {
        console.error('Error loading tiles config:', e);
    }
}
</script>